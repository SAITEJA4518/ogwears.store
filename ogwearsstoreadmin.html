<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OG WEARS Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Charts + PDF + QR + Barcode -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
    body{min-height:100vh;background:#fff;color:#222;}
    aside{width:240px;background:#000;color:#fff;display:flex;flex-direction:column;align-items:center;padding:20px 0;position:fixed;left:0;top:0;bottom:0;animation:slideInLeft .5s ease;}
    aside h1{font-size:20px;margin-bottom:30px;letter-spacing:.5px;animation:fadeIn .8s ease;}
    aside nav a{color:#fff;text-decoration:none;display:block;padding:12px 20px;width:100%;text-align:left;transition:0.2s;position:relative;}
    aside nav a:hover,aside nav a.active{background:#e50914;}
    aside nav a i{width:18px;display:inline-block;margin-right:8px;}
    main{margin-left:240px;padding:30px;overflow-y:auto;}
    h2{margin-bottom:20px;font-weight:600;animation:fadeInUp .5s ease;}
    table{width:100%;border-collapse:collapse;margin-bottom:20px;}
    table th,table td{padding:10px;border:1px solid #ddd;text-align:left;vertical-align:top;}
    button{padding:8px 12px;background:#e50914;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;transition:transform .15s ease;}
    button.secondary{background:#666;}
    button.ghost{background:#fff;color:#e50914;border:1px solid #e50914;}
    button:hover{opacity:.95;transform:translateY(-1px);}
    .muted{color:#666;font-size:12px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .form-group{margin-bottom:12px;min-width:220px;flex:1}
    .form-group label{display:block;margin-bottom:6px;font-weight:500;}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;}
    .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:30px;}
    .card{background:#f7f7f7;padding:20px;border-radius:10px;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,0.08);animation:fadeInUp .6s ease;}
    .card h3{margin-bottom:10px;}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .fade-in{animation:fade .6s ease-in;}
    @keyframes fade{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    @keyframes slideInLeft{from{opacity:0;transform:translateX(-40px)}to{opacity:1;transform:translateX(0)}}
    #loginScreen{display:flex;justify-content:center;align-items:center;height:100vh;background:#000;color:#fff;}
    #loginBox{background:#111;padding:30px;border-radius:12px;box-shadow:0 0 14px rgba(0,0,0,0.5);text-align:center;width:320px;animation:fadeInUp .5s ease;}
    #loginBox h2{margin-bottom:18px;color:#e50914;}
    #loginBox input{width:100%;padding:12px;margin-bottom:15px;border:none;border-radius:8px;}
    #loginBox button{width:100%;}
    .popup-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;z-index:1000;}
    .popup-content{background:#fff;padding:20px;border-radius:12px;max-width:760px;width:92%;max-height:92vh;overflow-y:auto;position:relative;box-shadow:0 12px 40px rgba(0,0,0,.25);animation:fadeInUp .4s ease;}
    .popup-close{position:absolute;top:10px;right:10px;background:#e50914;color:#fff;width:34px;height:34px;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;font-weight:700;}
    .popup-actions{margin-top:16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .divider{height:1px;background:#eee;margin:14px 0}
    .small{font-size:12px}
    .table-wrap{overflow:auto;border:1px solid #eee;border-radius:10px}
    .table-wrap table{margin:0;border:none}
    .table-wrap th,.table-wrap td{border-color:#eee}
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginScreen">
    <div id="loginBox">
      <h2>OG WEARS Admin</h2>
      <input type="password" id="adminPass" placeholder="Enter Password" />
      <button onclick="checkLogin()">Login</button>
      <p id="loginMsg" style="color:#ff6b6b;margin-top:10px;"></p>
      <p class="muted" style="margin-top:6px;">Hint for demo: <b>OG45</b></p>
    </div>
  </div>
  <!-- APP -->
  <div id="adminPanel" style="display:none;">
    <aside>
      <h1>OG Admin</h1>
      <nav>
        <a href="#" class="active" onclick="showSection(event,'dashboard')"><i class="fa fa-chart-line"></i> Dashboard</a>
        <a href="#" onclick="showSection(event,'users')"><i class="fa fa-users"></i> Users</a>
        <a href="#" onclick="showSection(event,'orders')"><i class="fa fa-box"></i> Orders</a>
        <a href="#" onclick="showSection(event,'products')"><i class="fa fa-tshirt"></i> Products</a>
        <a href="#" onclick="showSection(event,'coupons')"><i class="fa fa-tags"></i> Coupons</a>
        <a href="#" onclick="showSection(event,'revenue')"><i class="fa fa-dollar-sign"></i> Revenue</a>
        <a href="#" onclick="showSection(event,'settings')"><i class="fa fa-cog"></i> Settings</a>
        <a href="#" onclick="clearAllData()"><i class="fa fa-trash"></i> Clear All Data</a>
      </nav>
    </aside>
    <main>
      <!-- Dashboard -->
      <section id="dashboard" class="active fade-in">
        <h2>Dashboard</h2>
        <div class="dashboard">
          <div class="card"><h3 id="userCount">0</h3><p>Users</p></div>
          <div class="card"><h3 id="orderCount">0</h3><p>Orders</p></div>
          <div class="card"><h3 id="productCount">0</h3><p>Products</p></div>
          <div class="card"><h3 id="revenueTotal">â‚¹0</h3><p>Total Revenue</p></div>
        </div>
        <canvas id="analyticsChart" height="110"></canvas>
      </section>
      <!-- Users -->
      <section id="users" style="display:none;">
        <h2>Users</h2>
        <div class="toolbar">
          <button onclick="openUserForm()">+ Add User</button>
          <button class="ghost" onclick="exportCSV('users')"><i class="fa fa-file-export"></i> Export CSV</button>
        </div>
        <div class="table-wrap">
          <table id="usersTable">
            <thead><tr><th>S.No</th><th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <!-- Orders -->
      <section id="orders" style="display:none;">
        <h2>Orders</h2>
        <div class="toolbar">
          <button onclick="openOrderForm()">+ Add Order</button>
          <button class="ghost" onclick="exportCSV('orders')"><i class="fa fa-file-export"></i> Export CSV</button>
        </div>
        <div class="table-wrap">
          <table id="ordersTable">
            <thead>
              <tr>
                <th>S.No</th><th>ID</th><th>Name</th><th>Email</th><th>Phone</th><th>Address</th><th>Total</th><th>Status</th><th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="muted">Tip: Create a user first, then add an order selecting that user to auto-fill their Name/Email/Phone.</p>
      </section>
      <!-- Products -->
      <section id="products" style="display:none;">
        <h2>Products</h2>
        <div class="toolbar">
          <button onclick="showAddProductForm()">+ Add New Product</button>
          <button class="ghost" onclick="exportCSV('products')"><i class="fa fa-file-export"></i> Export CSV</button>
        </div>
        <div id="productForm" style="display:none;margin:16px 0;">
          <div class="row">
            <div class="form-group"><label>Title</label><input id="prodTitle"></div>
            <div class="form-group"><label>Image</label><input type="file" id="prodImage" accept="image/*"></div>
            <div class="form-group"><label>Actual Price</label><input type="number" id="prodActual" min="0"></div>
            <div class="form-group"><label>Discounted Price</label><input type="number" id="prodPrice" min="0"></div>
          </div>
          <div class="form-group"><label>Description</label><textarea id="prodDesc" rows="3"></textarea></div>
          <div class="row">
            <button onclick="addProduct()">Save Product</button>
            <button class="secondary" onclick="hideAddProductForm()">Cancel</button>
          </div>
          <div class="divider"></div>
        </div>
        <div class="table-wrap">
          <table id="productsTable">
            <thead><tr><th>S.No</th><th>ID</th><th>Title</th><th>Image</th><th>Price</th><th>Actual</th><th>Saved</th><th>Desc</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <!-- Coupons -->
      <section id="coupons" style="display:none;">
        <h2>Coupons</h2>
        <div class="row">
          <div class="form-group"><label>Code</label><input id="couponCode" placeholder="e.g. OG10"></div>
          <div class="form-group"><label>Discount %</label><input type="number" id="couponDiscount" min="0" max="100" placeholder="10"></div>
          <div class="form-group"><label>Valid Until</label><input type="date" id="couponValid"></div>
        </div>
        <div class="row">
          <button onclick="addCoupon()">Add Coupon</button>
        </div>
        <div class="divider"></div>
        <div class="table-wrap">
          <table id="couponTable">
            <thead><tr><th>S.No</th><th>Code</th><th>Discount %</th><th>Valid Until</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <!-- Revenue -->
      <section id="revenue" style="display:none;">
        <h2>Total Revenue</h2>
        <p id="revenueValue" style="font-size:22px;font-weight:700;">â‚¹0</p>
      </section>
      <!-- Settings -->
      <section id="settings" style="display:none;">
        <h2>Settings</h2>
        <div class="row">
          <div class="form-group"><label>Upload Logo</label><input type="file" id="logoUpload" accept="image/*"></div>
          <div class="form-group"><label>Shipping Cost (â‚¹)</label><input type="number" id="shippingCost" min="0"></div>
        </div>
        <button onclick="saveSettings()">Save Settings</button>
        <p class="muted" style="margin-top:6px;">Logo & shipping stored in your browser (localStorage).</p>
      </section>
    </main>
  </div>

  <!-- Receipt Popup -->
  <div id="receiptPopup" class="popup-overlay">
    <div class="popup-content">
      <div class="popup-close" onclick="closePopup('receiptPopup')">&times;</div>
      <div id="receiptContent"></div>
      <div class="popup-actions">
        <button onclick="printReceipt()">Print Receipt</button>
        <button class="ghost" onclick="downloadReceipt()">Download PDF</button>
      </div>
    </div>
  </div>

  <!-- Label Popup -->
  <div id="labelPopup" class="popup-overlay">
    <div class="popup-content">
      <div class="popup-close" onclick="closePopup('labelPopup')">&times;</div>
      <div id="labelContent"></div>
      <div class="popup-actions">
        <button onclick="printLabel()">Print Label</button>
        <button class="ghost" onclick="downloadLabel()">Download PDF</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit User Popup -->
  <div id="userPopup" class="popup-overlay">
    <div class="popup-content">
      <div class="popup-close" onclick="closePopup('userPopup')">&times;</div>
      <h3 id="userPopupTitle">Add User</h3>
      <div class="row">
        <div class="form-group"><label>Name</label><input id="userName"></div>
        <div class="form-group"><label>Email</label><input id="userEmail" type="email"></div>
        <div class="form-group"><label>Phone</label><input id="userPhone" type="tel"></div>
      </div>
      <div class="popup-actions">
        <button onclick="saveUser()">Save</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Order Popup -->
  <div id="orderPopup" class="popup-overlay">
    <div class="popup-content">
      <div class="popup-close" onclick="closePopup('orderPopup')">&times;</div>
      <h3 id="orderPopupTitle">Add Order</h3>
      <div class="row">
        <div class="form-group">
          <label>User</label>
          <select id="orderUser"></select>
        </div>
        <div class="form-group">
          <label>Product</label>
          <select id="orderProduct"></select>
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <input id="orderQty" type="number" min="1" value="1"/>
        </div>
      </div>
      <div class="row">
        <div class="form-group" style="flex:1 1 100%;">
          <label>Shipping Address</label>
          <textarea id="orderAddress" rows="2" placeholder="House No, Street, City, Pincode"></textarea>
        </div>
      </div>
      <div class="row">
        <div class="form-group"><label>Coupon Code (optional)</label><input id="orderCoupon" placeholder="OG10"></div>
        <div class="form-group"><label>Discount (â‚¹)</label><input id="orderDiscount" type="number" min="0" value="0"></div>
      </div>
      <div class="row">
        <div class="form-group"><label>Subtotal (auto)</label><input id="orderSubtotal" type="number" disabled></div>
        <div class="form-group"><label>Shipping (auto)</label><input id="orderShipCost" type="number" disabled></div>
        <div class="form-group"><label>Total (auto)</label><input id="orderTotal" type="number" disabled></div>
      </div>
      <div class="popup-actions">
        <button onclick="saveOrder()">Save Order</button>
      </div>
      <p class="muted" id="orderCalcNote"></p>
    </div>
  </div>

<script>
function checkLogin(){
  const pass = document.getElementById("adminPass").value;
  if(pass === "OG45"){
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
    loadData();
  }else{
    document.getElementById("loginMsg").innerText = "Wrong Password!";
  }
}
function showSection(event, id){
  document.querySelectorAll("main section").forEach(s => s.style.display = "none");
  const section = document.getElementById(id);
  if(section) section.style.display = "block";
  document.querySelectorAll("aside nav a").forEach(a => a.classList.remove("active"));
  if(event && event.currentTarget) event.currentTarget.classList.add("active");
  if(id === "dashboard") loadDashboard();
  if(id === "users") loadUsers();
  if(id === "orders") loadOrders();
  if(id === "products") loadProducts();
  if(id === "coupons") loadCoupons();
  if(id === "revenue") loadDashboard();
  if(id === "settings") loadSettingsUI();
  if(id === "cancelledOrders") loadCancelledOrders();
}

const $ = sel => document.querySelector(sel);
function uid(prefix){ return prefix + Math.floor(Date.now() + Math.random()*1000); }
function parseNumber(n){ const x = parseFloat(n); return isNaN(x) ? 0 : x; }
function formatINR(n){ try{ return new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(n||0); }catch(e){ return "â‚¹"+(n||0); } }

function showPopup(id){ document.getElementById(id).style.display = "flex"; }
function closePopup(id){ document.getElementById(id).style.display = "none"; }

function saveSettings(){
  const file = $("#logoUpload").files[0];
  const ship = parseNumber($("#shippingCost").value);
  const setDone = () => {
    localStorage.setItem("shippingCost", ship);
    loadSettingsUI();
    alert("Settings saved");
  };
  if(file){
    const r = new FileReader();
    r.onload = e => { localStorage.setItem("siteLogo", e.target.result); setDone(); };
    r.readAsDataURL(file);
  } else {
    setDone();
  }
}
function loadSettingsUI(){
  const ship = localStorage.getItem("shippingCost") || 0;
  $("#shippingCost").value = ship;
}

function loadUsers(){
  const users = JSON.parse(localStorage.getItem("users")||"[]");
  const tb = $("#usersTable tbody");
  tb.innerHTML = "";
  users.forEach((u,i)=>{
    tb.innerHTML += `<tr>
      <td>${i+1}</td>
      <td>${u.id}</td>
      <td>${u.name||"-"}</td>
      <td>${u.email||"-"}</td>
      <td>${u.phone||"-"}</td>
      <td class="row" style="gap:6px">
        <button class="ghost" onclick='openUserForm(${JSON.stringify(u)})'>Edit</button>
        <button class="secondary" onclick='deleteUser("${u.id}")'>Delete</button>
      </td>
    </tr>`;
  });
  $("#userCount").innerText = users.length;
}
function openUserForm(user=null){
  $("#userPopupTitle").innerText = user? "Edit User":"Add User";
  $("#userName").value = user?.name||"";
  $("#userEmail").value = user?.email||"";
  $("#userPhone").value = user?.phone||"";
  $("#userPopup").dataset.editId = user?.id || "";
  showPopup("userPopup");
}
function saveUser(){
  const id = $("#userPopup").dataset.editId || uid("USR");
  const user = {
    id,
    name: $("#userName").value.trim(),
    email: $("#userEmail").value.trim(),
    phone: $("#userPhone").value.trim(),
  };
  let users = JSON.parse(localStorage.getItem("users")||"[]");
  const idx = users.findIndex(u=>u.id===id);
  if(idx>-1) users[idx]=user; else users.push(user);
  localStorage.setItem("users", JSON.stringify(users));
  closePopup("userPopup");
  loadUsers();
}
function deleteUser(id){
  if(!confirm("Delete this user?")) return;
  let users = JSON.parse(localStorage.getItem("users")||"[]");
  users = users.filter(u=>u.id!==id);
  localStorage.setItem("users", JSON.stringify(users));
  loadUsers();
}

function showAddProductForm(){ $("#productForm").style.display="block"; }
function hideAddProductForm(){ $("#productForm").style.display="none"; clearProductForm(); }
function clearProductForm(){
  $("#prodTitle").value=""; $("#prodDesc").value="";
  $("#prodActual").value=""; $("#prodPrice").value="";
  $("#prodImage").value="";
}
function addProduct(){
  const title = $("#prodTitle").value.trim();
  const desc = $("#prodDesc").value.trim();
  const actual = parseNumber($("#prodActual").value);
  const price = parseNumber($("#prodPrice").value);
  const file = $("#prodImage").files[0];
  const save = (imgData)=> {
    const p = { id: uid("PRD"), title, desc, actual, price, saved: Math.max(0, actual-price), image: imgData||"" };
    const products = JSON.parse(localStorage.getItem("products")||"[]");
    products.push(p);
    localStorage.setItem("products", JSON.stringify(products));
    hideAddProductForm();
    loadProducts();
  };
  if(file){
    const r = new FileReader();
    r.onload = e => save(e.target.result);
    r.readAsDataURL(file);
  } else { save(""); }
}
function loadProducts(){
  const products = JSON.parse(localStorage.getItem("products")||"[]");
  const tb = $("#productsTable tbody");
  tb.innerHTML = "";
  products.forEach((p,i)=>{
    tb.innerHTML += `<tr>
      <td>${i+1}</td>
      <td>${p.id}</td>
      <td>${p.title||"-"}</td>
      <td>${p.image?`<img src="${p.image}" style="height:40px;border-radius:6px">`:"-"}</td>
      <td>${formatINR(p.price||0)}</td>
      <td>${formatINR(p.actual||0)}</td>
      <td>${formatINR(p.saved||0)}</td>
      <td class="small">${p.desc||"-"}</td>
      <td class="row" style="gap:6px">
        <button class="secondary" onclick='deleteProduct("${p.id}")'>Delete</button>
      </td>
    </tr>`;
  });
  $("#productCount").innerText = products.length;
}
function deleteProduct(id){
  if(!confirm("Delete this product?")) return;
  let products = JSON.parse(localStorage.getItem("products")||"[]");
  products = products.filter(p=>p.id!==id);
  localStorage.setItem("products", JSON.stringify(products));
  loadProducts();
}

function addCoupon(){
  const code = $("#couponCode").value.trim().toUpperCase();
  const discount = parseNumber($("#couponDiscount").value);
  const validUntil = $("#couponValid").value;
  if(!code){ alert("Enter code"); return; }
  const coupons = JSON.parse(localStorage.getItem("coupons")||"[]");
  coupons.push({ code, discount, validUntil });
  localStorage.setItem("coupons", JSON.stringify(coupons));
  $("#couponCode").value=""; $("#couponDiscount").value=""; $("#couponValid").value="";
  loadCoupons();
}
function loadCoupons(){
  const coupons = JSON.parse(localStorage.getItem("coupons")||"[]");
  const tb = $("#couponTable tbody");
  tb.innerHTML="";
  coupons.forEach((c,i)=>{
    tb.innerHTML += `<tr>
      <td>${i+1}</td><td>${c.code}</td><td>${c.discount}%</td><td>${c.validUntil||"-"}</td>
    </tr>`;
  });
}

let currentReceiptOrder = null;
let currentLabelOrder = null;
function getOrderUserInfo(order) {
  let name = "-", email = "-", phone = "-";
  if(order.user && typeof order.user === "object") {
    name = order.user.name || "-";
    email = order.user.email || "-";
    phone = order.user.phone || "-";
  } else if(order.userId) {
    const users = JSON.parse(localStorage.getItem("users")||"[]");
    const u = users.find(u => u.id === order.userId);
    if(u) { name = u.name||"-"; email = u.email||"-"; phone = u.phone||"-"; }
    else { name = order.name||"-"; email = order.email||"-"; phone = order.phone||"-"; }
  } else {
    name = order.name||"-"; email = order.email||"-"; phone = order.phone||"-";
  }
  return {name, email, phone};
}
function openOrderForm(order=null){
  const users = JSON.parse(localStorage.getItem("users")||"[]");
  const products = JSON.parse(localStorage.getItem("products")||"[]");
  const uSel = $("#orderUser"), pSel = $("#orderProduct");
  uSel.innerHTML = `<option value="">-- Select User --</option>` + users.map(u=>`<option value="${u.id}">${u.name} (${u.email})</option>`).join("");
  pSel.innerHTML = `<option value="">-- Select Product --</option>` + products.map(p=>`<option value="${p.id}" data-price="${p.price||0}">${p.title} - ${formatINR(p.price||0)}</option>`).join("");
  $("#orderQty").value = order?.items?.[0]?.qty || 1;
  $("#orderAddress").value = order?.address||"";
  $("#orderCoupon").value = order?.coupon||"";
  $("#orderDiscount").value = order?.discount||0;
  if(order?.userId) uSel.value = order.userId;
  if(order?.items?.[0]?.productId) pSel.value = order.items[0].productId;
  $("#orderPopup").dataset.editId = order?.id || "";
  calcOrderTotals();
  showPopup("orderPopup");
  uSel.onchange = calcOrderTotals;
  pSel.onchange = calcOrderTotals;
  $("#orderQty").oninput = calcOrderTotals;
  $("#orderCoupon").oninput = calcOrderTotals;
  $("#orderDiscount").oninput = calcOrderTotals;
}
function calcOrderTotals(){
  const pSel = $("#orderProduct");
  const qty = parseNumber($("#orderQty").value) || 1;
  const price = parseNumber(pSel.options[pSel.selectedIndex]?.dataset?.price || 0);
  const subtotal = price * qty;
  const ship = parseNumber(localStorage.getItem("shippingCost")||0);
  const discount = parseNumber($("#orderDiscount").value) || 0;
  const total = Math.max(0, subtotal + ship - discount);
  $("#orderSubtotal").value = subtotal;
  $("#orderShipCost").value = ship;
  $("#orderTotal").value = total;
  $("#orderCalcNote").innerText = `Subtotal ${formatINR(subtotal)} + Shipping ${formatINR(ship)} - Discount ${formatINR(discount)} = Total ${formatINR(total)}`
}
function saveOrder(){
  const id = $("#orderPopup").dataset.editId || uid("ORD");
  const userId = $("#orderUser").value;
  const productId = $("#orderProduct").value;
  const qty = parseNumber($("#orderQty").value) || 1;
  const address = $("#orderAddress").value.trim();
  const coupon = $("#orderCoupon").value.trim().toUpperCase();
  const discount = parseNumber($("#orderDiscount").value)||0;
  const subtotal = parseNumber($("#orderSubtotal").value)||0;
  const shipping = parseNumber($("#orderShipCost").value)||0;
  const total = parseNumber($("#orderTotal").value)||0;
  const products = JSON.parse(localStorage.getItem("products")||"[]");
  const prod = products.find(p=>p.id===productId);
  const item = prod ? { productId, title: prod.title, price: prod.price||0, qty } : { productId, title: "-", price:0, qty };
  let orders = JSON.parse(localStorage.getItem("orders")||"[]");
  let existingOrder = orders.find(o=>o.id===id);
  const payload = { id, userId, address, coupon, discount, subtotal, shipping, total, date: Date.now(), items:[item], status: existingOrder ? existingOrder.status : "Placed" };
  const idx = orders.findIndex(o=>o.id===id);
  if(idx>-1) orders[idx]=payload; else orders.push(payload);
  localStorage.setItem("orders", JSON.stringify(orders));
  closePopup("orderPopup");
  loadOrders();
  loadDashboard();
}
function loadOrders(){
  const orders = JSON.parse(localStorage.getItem("orders")||"[]");
  const tbody = $("#ordersTable tbody");
  tbody.innerHTML = "";
  orders.forEach((o,i)=>{
    const {name, email, phone} = getOrderUserInfo(o);
    tbody.innerHTML += `<tr>
      <td>${i+1}</td>
      <td>${o.id}</td>
      <td>${name}</td>
      <td>${email}</td>
      <td>${phone}</td>
      <td>${o.address || '-'}</td>
      <td>${formatINR(o.total||0)}</td>
      <td>
        <span class="order-status">${o.status||"Placed"}</span>
        ${getStatusButton(o.status||"Placed", o.id)}
      </td>
      <td class="row" style="gap:6px">
        <button class="btn-receipt" data-oid="${o.id}">Receipt</button>
        <button class="secondary btn-label" data-oid="${o.id}">Label</button>
        <button class="ghost" onclick='openOrderForm(${JSON.stringify(o)})'>Edit</button>
      </td>
    </tr>`;
  });
  $("#orderCount").innerText = orders.length;

  tbody.querySelectorAll('.btn-receipt').forEach(btn => {
    btn.onclick = () => {
      const oid = btn.getAttribute('data-oid');
      const orders = JSON.parse(localStorage.getItem("orders")||"[]");
      const order = orders.find(o => o.id === oid);
      showReceipt(order);
    };
  });
  tbody.querySelectorAll('.btn-label').forEach(btn => {
    btn.onclick = () => {
      const oid = btn.getAttribute('data-oid');
      const orders = JSON.parse(localStorage.getItem("orders")||"[]");
      const order = orders.find(o => o.id === oid);
      showLabel(order);
    };
  });
}

function getStatusButton(status, oid){
  if(status==="Placed")
    return `<button onclick="updateOrderStatus('${oid}','Packed')">Mark as Packed</button>`;
  if(status==="Packed")
    return `<button onclick="updateOrderStatus('${oid}','Shipped')">Mark as Shipped</button>`;
  if(status==="Shipped")
    return `<button onclick="updateOrderStatus('${oid}','Delivered')">Mark as Delivered</button>`;
  if(status==="Delivered")
    return `<button disabled style="background:#888;cursor:not-allowed;">Delivered</button>`;
  return '';
}
function updateOrderStatus(oid, newStatus){
  let orders = JSON.parse(localStorage.getItem("orders")||"[]");
  const idx = orders.findIndex(o=>o.id===oid);
  if(idx>-1){
    orders[idx].status = newStatus;
    localStorage.setItem("orders", JSON.stringify(orders));
    loadOrders();
    loadDashboard();
  }
}

function showReceipt(order){
  if(!order) return alert("Order not found!");
  const shippingCost = parseNumber(localStorage.getItem("shippingCost")||0);
  const logo = localStorage.getItem("siteLogo") || "";
  const logoHtml = logo ? `<img src="${logo}" style="height:50px;margin-bottom:10px;"/>` : `<h2 style="color:#e50914;margin:0;">OG WEARS</h2>`;
  const {name, email, phone} = getOrderUserInfo(order);
  const receiptHtml = `
    <div style="font-family:Poppins;padding:16px;border:2px solid #000;width:100%;line-height:1.45;">
      <div style="text-align:center;">${logoHtml}<p style="margin:4px 0 10px">Wear Confidence. Wear OG.</p></div>
      <hr>
      <p><b>Date:</b> ${new Date(order.date || Date.now()).toLocaleString()}</p>
      <h3 style="margin:8px 0">Receipt - ${order.id}</h3>
      <p><b>Name:</b> ${name}</p>
      <p><b>Email:</b> ${email}</p>
      <p><b>Phone:</b> ${phone}</p>
      <p><b>Address:</b> ${order.address||'-'}</p>
      <h4 style="margin:10px 0 6px">Products:</h4>
      <ul style="margin-left:18px">${(order.items||[]).map(it=>`<li>${it.title} x ${it.qty||1} â€” â‚¹${(it.price||0)*(it.qty||1)}</li>`).join("")}</ul>
      <h4 style="margin:10px 0 6px">Billing:</h4>
      <p>Subtotal: â‚¹${order.subtotal||0}</p>
      <p>Discount: â‚¹${order.discount||0}</p>
      <p>Shipping: â‚¹${order.shipping ?? shippingCost}</p>
      <p><b>Total: â‚¹${order.total||0}</b></p>
      <hr><p style="text-align:center;margin:6px 0 0">Thank you for shopping with OG WEARS!</p>
    </div>`;
  $("#receiptContent").innerHTML = receiptHtml;
  currentReceiptOrder = order;
  showPopup("receiptPopup");
}

function showLabel(order){
  if(!order) return alert("Order not found!");
  const shippingCost = parseNumber(localStorage.getItem("shippingCost")||0);
  const logo = localStorage.getItem("siteLogo") || "";
  const logoHtml = logo ? `<img src="${logo}" style="height:40px;margin-bottom:8px;"/>` : `<h2 style="color:#e50914;margin:0;">OG WEARS</h2>`;
  const {name, email, phone} = getOrderUserInfo(order);
  const HOST_URL = window.location.origin + window.location.pathname;
  const labelUrl = `${HOST_URL}?openLabel=${encodeURIComponent(order.id)}`;
  const labelHtml = `
    <div id="labelBlock" style="font-family:Poppins;padding:14px;border:2px solid #000;width:100%;text-align:center;line-height:1.35;">
      <div>${logoHtml}<p style="margin:0 0 6px"><b>Order Label</b></p></div>
      <p style="text-align:left;margin:4px 0"><b>Date:</b> ${new Date(order.date||Date.now()).toLocaleString()}</p>
      <p style="text-align:left;margin:4px 0"><b>Order ID:</b> ${order.id}</p>
      <p style="text-align:left;margin:4px 0"><b>Name:</b> ${name}</p>
      <p style="text-align:left;margin:4px 0"><b>Email:</b> ${email}</p>
      <p style="text-align:left;margin:4px 0"><b>Phone:</b> ${phone}</p>
      <p style="text-align:left;margin:4px 0"><b>Address:</b> ${order.address||'-'}</p>
      <h4 style="text-align:left;margin:8px 0 4px">Items:</h4>
      <ul style="list-style:none;padding-left:0;text-align:left;margin:0 0 6px">${(order.items||[]).map(it=>`<li>${it.title} x ${it.qty||1} â€” â‚¹${(it.price||0)*(it.qty||1)}</li>`).join("")}</ul>
      <h4 style="text-align:left;margin:8px 0 8px">Total: â‚¹${order.total||0} (incl. â‚¹${order.shipping ?? shippingCost} shipping)</h4>
      <div style="display:flex;gap:16px;justify-content:center;align-items:center;margin:10px 0;flex-wrap:wrap">
        <div id="qrCodeContainer"></div>
        <svg id="barcodeSvg"></svg>
      </div>
      <p style="margin-top:4px;">Thank you for shopping OG WEARS</p>
    </div>`;
  $("#labelContent").innerHTML = labelHtml;
  document.getElementById("qrCodeContainer").innerHTML = "";
  new QRCode(document.getElementById("qrCodeContainer"), { text: labelUrl, width: 100, height: 100 });
  JsBarcode("#barcodeSvg", order.id || "ORDER", { format: "CODE128", width: 2, height: 50, displayValue: true });
  currentLabelOrder = order;
  showPopup("labelPopup");
}

function printReceipt(){
  if(!currentReceiptOrder){ alert("Open a receipt first"); return; }
  const w = window.open("", "_blank");
  w.document.write(`<html><head><title>Receipt</title></head><body>${$("#receiptContent").innerHTML}</body></html>`);
  w.document.close(); w.focus(); w.print(); w.close();
}

function downloadReceipt(){
  if(!currentReceiptOrder){ alert("Open a receipt first"); return; }
  html2pdf().set({ filename:`Receipt_${currentReceiptOrder.id}.pdf` }).from($("#receiptContent")).save();
}

function printLabel(){
  if(!currentLabelOrder){ alert("Open a label first"); return; }
  const w = window.open("", "_blank");
  w.document.write(`<html><head><title>Label</title></head><body>${$("#labelContent").innerHTML}</body></html>`);
  w.document.close(); w.focus(); w.print(); w.close();
}

function downloadLabel(){
  if(!currentLabelOrder){ alert("Open a label first"); return; }
  html2pdf().set({ filename:`Label_${currentLabelOrder.id}.pdf` }).from($("#labelContent")).save();
}

let analyticsChart;
function loadDashboard(){
  const users = JSON.parse(localStorage.getItem("users")||"[]");
  const orders = JSON.parse(localStorage.getItem("orders")||"[]");
  const products = JSON.parse(localStorage.getItem("products")||"[]");
  const revenue = orders.reduce((s,o)=>s + (o.total||0), 0);
  $("#userCount").innerText = users.length;
  $("#orderCount").innerText = orders.length;
  $("#productCount").innerText = products.length;
  $("#revenueTotal").innerText = formatINR(revenue);
  $("#revenueValue") && ($("#revenueValue").innerText = formatINR(revenue));
  const labels = orders.slice(-7).map(o=> new Date(o.date||Date.now()).toLocaleDateString());
  const totals = orders.slice(-7).map(o=> o.total||0);
  const ctx = document.getElementById("analyticsChart");
  if(!ctx) return;
  if(analyticsChart) analyticsChart.destroy();
  analyticsChart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets: [{ label: "Recent Order Totals", data: totals }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });
}

function exportCSV(type){
  let data = [];
  if(type === "users") data = JSON.parse(localStorage.getItem("users")||"[]");
  if(type === "orders") data = JSON.parse(localStorage.getItem("orders")||"[]");
  if(type === "products") data = JSON.parse(localStorage.getItem("products")||"[]");
  if(type === "coupons") data = JSON.parse(localStorage.getItem("coupons")||"[]");
  if(data.length === 0){
    alert("No " + type + " data to export!");
    return;
  }
  const headers = [...new Set(data.flatMap(obj=>Object.keys(obj)))];
  const rows = data.map(obj => headers.map(h => {
    const val = (typeof obj[h]==="object") ? JSON.stringify(obj[h]) : (obj[h]??"");
    return `"${val.toString().replace(/"/g,'""')}"`;
  }).join(","));
  const csv = [headers.join(","), ...rows].join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `${type}_data.csv`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function clearAllData(){
  if(!confirm("Clear ALL data in localStorage?")) return;
  localStorage.clear();
  alert("All data cleared!");
  loadUsers();
  loadOrders();
  loadProducts();
  loadCoupons();
  loadDashboard();
  loadSettingsUI();
  const firstLink = document.querySelector("aside nav a");
  showSection({currentTarget:firstLink}, "dashboard");
}

function seedDemo(){
  if(!localStorage.getItem("users")){
    localStorage.setItem("users", JSON.stringify([
      {id:"USR1001", name:"Aarav Sharma", email:"aarav@example.com", phone:"9876543210"},
      {id:"USR1002", name:"Priya Singh", email:"priya@example.com", phone:"9876501234"}
    ]));
  }
  if(!localStorage.getItem("products")){
    localStorage.setItem("products", JSON.stringify([
      {id:"PRD2001", title:"OG Tee Black", desc:"Premium cotton tee", actual:799, price:499, saved:300, image:""},
      {id:"PRD2002", title:"OG Hoodie Red", desc:"Cozy fleece hoodie", actual:1999, price:1499, saved:500, image:""}
    ]));
  }
  if(!localStorage.getItem("orders")){
    localStorage.setItem("orders", JSON.stringify([
      {id:"ORD3001", userId:"USR1001", address:"221B Baker Street, Mumbai 400001", coupon:"", discount:0, subtotal:499, shipping:50, total:549, date: Date.now()-86400000, items:[{productId:"PRD2001", title:"OG Tee Black", price:499, qty:1}], status: "Placed"},
      {id:"ORD3002", userId:"USR1002", address:"H.No 42, Delhi 110001", coupon:"", discount:0, subtotal:1499, shipping:50, total:1549, date: Date.now()-43200000, items:[{productId:"PRD2002", title:"OG Hoodie Red", price:1499, qty:1}], status: "Placed"}
    ]));
  }
  if(!localStorage.getItem("shippingCost")){
    localStorage.setItem("shippingCost", "50");
  }
}

function loadData(){
  if (!localStorage.getItem("users") || !localStorage.getItem("products") || !localStorage.getItem("orders")) {
    seedDemo();
  }
  loadUsers();
  loadOrders();
  loadProducts();
  loadCoupons();
  loadDashboard();
  loadSettingsUI();
}

// New function to load Cancelled Orders section
function loadCancelledOrders(){
  const orders = JSON.parse(localStorage.getItem("orders")||"[]");
  const users = JSON.parse(localStorage.getItem("users")||"[]");
  const tbody = document.querySelector("#cancelledOrdersTable tbody");
  tbody.innerHTML = "";
  const cancelled = orders.filter(o => o.status && o.status.toLowerCase() === "cancelled");
  cancelled.forEach((order, index) => {
    const user = users.find(u => u.id === order.userId) || {};
    const productNames = (order.items || []).map(item => item.title).join(", ") || "-";
    tbody.innerHTML += `<tr>
      <td>${index + 1}</td>
      <td>${user.id || "-"}</td>
      <td>${user.name || "-"}</td>
      <td>${user.email || "-"}</td>
      <td>${user.phone || "-"}</td>
      <td>${order.id}</td>
      <td>${productNames}</td>
      <td>${order.status}</td>
    </tr>`;
  });
}
</script>
</body>
</html>
